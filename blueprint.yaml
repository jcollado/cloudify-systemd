tosca_definitions_version: cloudify_dsl_1_3

dsl_definitions:
  - &fabric_script
    use_sudo: true
    fabric_env:
      user: { get_input: ssh_user }
      key_filename: { get_input: ssh_private_key_path }

description: Run services using systemd node type

imports:
  - http://www.getcloudify.org/spec/cloudify/3.4/types.yaml
  - http://www.getcloudify.org/spec/fabric-plugin/1.4.2/plugin.yaml
  - types/systemd.yaml

inputs:
  host_ip:
    description: IP address where the vagrant VM is running
    type: string
  ssh_user:
    description: User name when connecting through SSH
    type: string
  ssh_private_key_path:
    description: Path to the private key to connect through SSH
    type: string

node_templates:
  vagrant_vm:
    type: cloudify.nodes.Compute
    properties:
      ip: { get_input: host_ip }
      install_agent: false

  mongod:
    type: systemd
    relationships:
      - type: cloudify.relationships.contained_in
        target: vagrant_vm
    properties:
      service_name: mongod
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            <<: *fabric_script
            script_path: scripts/mongod-create.py
        delete:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            <<: *fabric_script
            script_path: scripts/mongod-delete.py

  app:
    type: systemd
    relationships:
      - type: cloudify.relationships.contained_in
        target: vagrant_vm
    properties:
      service_name: app
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            <<: *fabric_script
            script_path: scripts/app-create.py
        delete:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            <<: *fabric_script
            script_path: scripts/app-delete.py
